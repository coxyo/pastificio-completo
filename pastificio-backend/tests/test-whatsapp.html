<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WhatsApp Pastificio</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-height: 50px;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .info {
            color: blue;
        }
        input {
            padding: 8px;
            margin: 5px;
            width: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>üçù Test WhatsApp - Pastificio Nonna Claudia</h1>
    
    <div class="section">
        <h2>1. Login</h2>
        <button id="loginBtn" onclick="login()">Effettua Login</button>
        <span id="loginStatus"></span>
    </div>

    <div class="section">
        <h2>2. Verifica Stato WhatsApp</h2>
        <button id="statusBtn" onclick="checkWhatsAppStatus()" disabled>Controlla Stato</button>
        <span id="waStatus"></span>
    </div>

    <div class="section">
        <h2>3. Invia Messaggio Test</h2>
        <input type="text" id="phoneNumber" placeholder="Numero (es: 3401234567)" value="3497319143">
        <input type="text" id="message" placeholder="Messaggio" value="Test dal sistema Pastificio üçù">
        <br>
        <button id="sendBtn" onclick="sendWhatsApp()" disabled>Invia WhatsApp</button>
    </div>

    <div class="section">
        <h2>4. Test Ordine con WhatsApp</h2>
        <button id="orderBtn" onclick="createOrderWithWhatsApp()" disabled>Crea Ordine e Notifica</button>
    </div>

    <div id="result">
        <strong>Risultati:</strong>
        <div id="resultContent">In attesa di azioni...</div>
    </div>

    <script>
        const API_URL = 'https://pastificio-backend.onrender.com';
        let token = localStorage.getItem('token');

        function updateResult(message, type = 'info') {
            const resultDiv = document.getElementById('resultContent');
            const timestamp = new Date().toLocaleTimeString();
            resultDiv.innerHTML = `<span class="${type}">[${timestamp}] ${message}</span><br>` + resultDiv.innerHTML;
        }

        async function login() {
            try {
                updateResult('Login in corso...', 'info');
                document.getElementById('loginBtn').disabled = true;
                
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@pastificio.com',
                        password: 'Admin123!'
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.token) {
                    token = data.token;
                    localStorage.setItem('token', data.token);
                    
                    document.getElementById('loginStatus').innerHTML = '<span class="success">‚úì Connesso</span>';
                    document.getElementById('statusBtn').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    document.getElementById('orderBtn').disabled = false;
                    
                    updateResult('Login effettuato con successo!', 'success');
                } else {
                    throw new Error(data.message || 'Login fallito');
                }
            } catch (error) {
                updateResult(`Errore login: ${error.message}`, 'error');
                document.getElementById('loginBtn').disabled = false;
            }
        }

        async function checkWhatsAppStatus() {
            try {
                updateResult('Controllo stato WhatsApp...', 'info');
                
                const response = await fetch(`${API_URL}/api/whatsapp/status`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.isConnected) {
                    document.getElementById('waStatus').innerHTML = '<span class="success">‚úì WhatsApp Connesso</span>';
                    updateResult('WhatsApp √® connesso e pronto!', 'success');
                } else {
                    document.getElementById('waStatus').innerHTML = '<span class="error">‚úó WhatsApp Non Connesso</span>';
                    updateResult('WhatsApp non √® connesso. Scansiona il QR code.', 'error');
                    
                    // Mostra link al QR
                    updateResult(`<a href="${API_URL}/api/whatsapp/qr" target="_blank">Clicca qui per vedere il QR Code</a>`, 'info');
                }
            } catch (error) {
                updateResult(`Errore verifica stato: ${error.message}`, 'error');
            }
        }

        async function sendWhatsApp() {
            try {
                const numero = document.getElementById('phoneNumber').value;
                const messaggio = document.getElementById('message').value;
                
                if (!numero || !messaggio) {
                    updateResult('Inserisci numero e messaggio', 'error');
                    return;
                }
                
                updateResult(`Invio messaggio a ${numero}...`, 'info');
                
                const response = await fetch(`${API_URL}/api/whatsapp/send`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        numero: numero,
                        messaggio: messaggio
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateResult(`Messaggio inviato con successo a ${numero}!`, 'success');
                } else {
                    throw new Error(data.message || 'Invio fallito');
                }
            } catch (error) {
                updateResult(`Errore invio: ${error.message}`, 'error');
            }
        }

        async function createOrderWithWhatsApp() {
            try {
                updateResult('Creazione ordine di test...', 'info');
                
                // Crea ordine
                const orderResponse = await fetch(`${API_URL}/api/ordini`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        cliente: {
                            nome: "Mario Rossi",
                            telefono: "3497319143"
                        },
                        prodotti: [
                            {
                                nome: "Papassinas",
                                quantita: 2,
                                prezzo: 15
                            }
                        ],
                        totale: 30,
                        stato: "nuovo",
                        dataConsegna: new Date().toISOString(),
                        note: "Ordine test con notifica WhatsApp"
                    })
                });
                
                const orderData = await orderResponse.json();
                
                if (orderData.success) {
                    updateResult(`Ordine creato: ID ${orderData.ordine._id}`, 'success');
                    
                    // Invia notifica WhatsApp
                    const waResponse = await fetch(`${API_URL}/api/whatsapp/ordine/nuovo`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ordineId: orderData.ordine._id
                        })
                    });
                    
                    const waData = await waResponse.json();
                    
                    if (waData.success) {
                        updateResult('Notifica WhatsApp inviata al cliente!', 'success');
                    } else {
                        updateResult('Ordine creato ma notifica WhatsApp fallita', 'error');
                    }
                } else {
                    throw new Error('Creazione ordine fallita');
                }
            } catch (error) {
                updateResult(`Errore: ${error.message}`, 'error');
            }
        }

        // Auto-login se token presente
        if (token) {
            document.getElementById('loginStatus').innerHTML = '<span class="info">Token trovato, verifica...</span>';
            document.getElementById('statusBtn').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('orderBtn').disabled = false;
            checkWhatsAppStatus();
        }
    </script>
</body>
</html>